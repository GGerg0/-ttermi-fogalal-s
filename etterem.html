<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="etterem.css">
    <title>Étterem</title>
  </head>
  <body>
    <h1>Étterem asztalfoglalás</h1>
    <div id="foglalas">
    <h3>Időpontfoglalás</h3>
    <label for="nev">Név: </label
    ><input name="nev" type="text" id="nev" /><br />
    <label for="nap">Nap: </label
    ><select name="nap" id="nap">
      <option value="1">Hétfő</option>
      <option value="2" selected>Kedd</option>
      <option value="3">Szerda</option>
      <option value="4">Csütörtök</option>
      <option value="5">Péntek</option>
      <option value="6">Szombat</option>
      <option value="7">Vasárnap</option></select
    ><br />
    
      <label for="ido">Időpont: </label
      ><input name="ido" type="time" id="ido" value="12:30" /><br />
      <label for="fo">Személyek száma: </label
      ><input name="fo" type="number" min="1" max="8" value="2" id="fo" /><br />
      <button id="create">Asztal foglalása</button>
    </div>
    <table>
      <tr id="myrow">
        <th>Hétfő</th>
      </tr>
      <tr>
        <th>Kedd</th>
      </tr>
      <tr>
        <th>Szerda</th>
      </tr>
      <tr>
        <th>Csütörtök</th>
      </tr>
      <tr>
        <th>Péntek</th>
      </tr>
      <tr>
        <th>Szombat</th>
      </tr>
      <tr>
        <th>Vasárnap</th>
      </tr>
    </table>


    <script>
      const nev = document.getElementById("nev");
      const nap = document.getElementById("nap");
      const ido = document.getElementById("ido");
      const fo = document.getElementById("fo");
      const create = document.getElementById("create");
      const napok = [
        document.querySelector("tr:first-child"),
        document.querySelector("tr:nth-child(2)"),
        document.querySelector("tr:nth-child(3)"),
        document.querySelector("tr:nth-child(4)"),
        document.querySelector("tr:nth-child(5)"),
        document.querySelector("tr:nth-child(6)"),
        document.querySelector("tr:last-child"),
      ];
      const dels = [];
      const edits = [];

      function OrderByTime() {
        let t = [];
        for (let i = 0; i < localStorage.length; i++) {
          t.push(JSON.parse(localStorage[localStorage.key(i)]));
        }
        t.sort((a, b) => a.nap - b.nap);
        return t;
      }

      function stringToPerc(s) {
        let tmp = s.split(":");
        return parseInt(tmp[0]) * 60 + parseInt(tmp[1]);
      }

      function kiIras(f) {
        switch (f.nap) {
          case 1:
            return `<div><p>Név: ${f.nev} <br>Nap: Hétfő-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 2:
            return `<div><p>Név: ${f.nev} <br>Időpont: Kedd-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 3:
            return `<div><p>Név: ${f.nev} <br>Időpont: Szerda-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 4:
            return `<div><p>Név: ${f.nev} <br>Időpont: Csütörtök-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 5:
            return `<div><p>Név: ${f.nev} <br>Időpont: Péntek-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 6:
            return `<div><p>Név: ${f.nev} <br>Időpont: Szombat-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
          case 7:
            return `<div><p>Név: ${f.nev} <br>Időpont: Vasárnap-${f.oraPerc} <br>Foglaltak száma: ${f.fo}</p></div>`;
        }
      }

      if (localStorage.length == 0) {
        localStorage.setItem(
          "Kovács András",
          JSON.stringify({
            nev: "Kovács András",
            nap: 1,
            oraPerc: "12:30",
            fo: 3,
          })
        );
        localStorage.setItem(
          "Szabó Katalin",
          JSON.stringify({
            nev: "Szabó Katalin",
            nap: 2,
            oraPerc: "11:45",
            fo: 6,
          })
        );
        localStorage.setItem(
          "Nagy Eszter",
          JSON.stringify({
            nev: "Nagy Eszter",
            nap: 6,
            oraPerc: "15:00",
            fo: 2,
          })
        );
        localStorage.setItem(
          "Tóth Gergely",
          JSON.stringify({
            nev: "Tóth Gergely",
            nap: 7,
            oraPerc: "18:15",
            fo: 4,
          })
        );
        localStorage.setItem(
          "Farkas Péter",
          JSON.stringify({
            nev: "Farkas Péter",
            nap: 5,
            oraPerc: "17:45",
            fo: 4,
          })
        );
      }

      create.addEventListener("click", () => {
        if (nev.value != "" && localStorage.getItem(nev.value) == null) {
          let f = {
            nev: nev.value,
            nap: parseInt(nap.value),
            oraPerc: ido.value,
            fo: parseInt(fo.value),
          };
          localStorage.setItem(f.nev, JSON.stringify(f));
        }
        Reload();
      });

      function Reload() {
        foglalasok = OrderByTime();
        for (let i = 1; i < 8; i++) {
          let napiFoglalas = foglalasok.filter((f) => f.nap == i);
          napiFoglalas.sort(
            (a, b) => stringToPerc(b.oraPerc) - stringToPerc(a.oraPerc)
          );
          for (let n = napok[i - 1].cells.length; n > 1; n--) {
            napok[i - 1].deleteCell(1);
            console.log(napok[i - 1].cells.length);
          }
          for (let j = 0; j < napiFoglalas.length; j++) {
            const row = napok[napiFoglalas[j].nap - 1];
            const cell = row.insertCell(1);
            let id = 0;
            cell.innerHTML = `${kiIras(
              napiFoglalas[j]
            )} <div>
              <button class="edit" id="edit${foglalasok.indexOf(
                napiFoglalas[j]
              )}">Szerkesztés</button> <button class="delete" id="Btn${foglalasok.indexOf(
                napiFoglalas[j]
              )}">Törlés</button>
            </div>`;
            dels.push(
              document.getElementById(
                `Btn${foglalasok.indexOf(napiFoglalas[j])}`
              )
            );
            edits.push(
              document.getElementById(
                `edit${foglalasok.indexOf(napiFoglalas[j])}`
              )
            );
          }
        }
        dels.forEach((b) => {
          let id = parseInt(b.id.slice(3));
          b.addEventListener("click", () => {
            const elem = document.querySelector(`td:has(#${b.id})`);
            elem.remove();
            localStorage.removeItem(foglalasok[id].nev);
          });
        });

        edits.forEach((b) => {
          let id = parseInt(b.id.slice(4));

          b.addEventListener("click", () => {
            dels.forEach((d) => {
              d.disabled = true;
            });
            edits.forEach((e) => {
              e.disabled = true;
            });
            document.querySelectorAll("input,select").forEach((i) => {
              i.disabled = true;
            });
            document.getElementById("create").disabled = true;
            const elem = document.querySelector(`td:has(#${b.id})`);
            elem.innerHTML = `<label for="nev">Név: </label ><input name="nev" type="text" id="enev" /> <br><label for="nap">Nap: </label ><select name="nap" id="enap"> <option value="1">Hétfő</option> <option value="2" selected>Kedd</option> <option value="3">Szerda</option> <option value="4">Csütörtök</option> <option value="5">Péntek</option> <option value="6">Szombat</option> <option value="7">Vasárnap</option></select > <br><label for="ido">Időpont: </label ><input name="ido" type="time" id="eido" value="12:30" /> <br><label for="efo">Személyek száma: </label ><input name="fo" type="number" min="1" max="8"  id="efo" /> <button id="ok">Ok</button>`;
            const ok = document.getElementById("ok");
            const enev = document.getElementById("enev");
            const enap = document.getElementById("enap");
            const eido = document.getElementById("eido");
            const efo = document.getElementById("efo");

            enev.value = foglalasok[id].nev;
            enap.value = foglalasok[id].nap;
            eido.value = foglalasok[id].oraPerc;
            efo.value = foglalasok[id].fo;
            console.log(foglalasok[id].ido);
            ok.addEventListener("click", () => {
              if (enev.value != "" && eido != "") {
                let f = {
                  nev: enev.value,
                  nap: parseInt(enap.value),
                  oraPerc: eido.value,
                  fo: parseInt(efo.value),
                };
                localStorage.removeItem(foglalasok[id].nev);
                localStorage.setItem(f.nev,JSON.stringify(f));
                
                  document.querySelectorAll("input,select").forEach((i) => {
                    i.disabled = false;
                  });
                  document.getElementById("create").disabled = false;
                
                Reload();
              }
            });
          });
        });
      }

      let foglalasok = OrderByTime();
      Reload();
    </script>
  </body>
</html>
